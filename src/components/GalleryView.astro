---
import { getAlbumImages } from '@/utils/images';
import { getImage } from 'astro:assets';
import ImageItem from '@/components/ImageItem.astro';
import justifiedLayout from 'justified-layout';

interface Props {
  gallerySlug: string;
  targetRowHeight?: number;
  spacing?: number;
}

const { gallerySlug, targetRowHeight = 360, spacing = 8 } = Astro.props;
const images = await getAlbumImages(gallerySlug);

// Generate full-size images for lightbox and tiny placeholders for blur effect
const processedImages = await Promise.all(
  images.map(async (img) => {
    const [fullSize, placeholder] = await Promise.all([
      getImage({
        src: img.image,
        format: 'webp',
        quality: 85,
        width: Math.min(img.image.width, 1600),
      }),
      getImage({
        src: img.image,
        format: 'webp',
        quality: 10,
        width: 20,
      }),
    ]);
    return {
      ...img,
      fullSrc: fullSize.src,
      placeholderSrc: placeholder.src,
    };
  })
);

// Calculate aspect ratios for justified layout
const aspectRatios = images.map((img) => img.image.width / img.image.height);

// Compute layout at a base width - we'll convert to percentages for responsiveness
// Use a width closer to typical content area for better row height scaling
const BASE_WIDTH = 800;
const layout = justifiedLayout(aspectRatios, {
  containerWidth: BASE_WIDTH,
  targetRowHeight,
  boxSpacing: spacing,
});

// Convert to percentage-based positions for responsive scaling
const boxes = layout.boxes.map(
  (box: { left: number; top: number; width: number; height: number }) => ({
    left: (box.left / BASE_WIDTH) * 100,
    top: box.top,
    width: (box.width / BASE_WIDTH) * 100,
    height: box.height,
  })
);

// Calculate aspect ratio of the entire container for responsive height
const containerAspectRatio = BASE_WIDTH / layout.containerHeight;

const galleryId = gallerySlug.replace(/[^a-zA-Z0-9]/g, '_');
---

<div
  class="gallery-justified w-full relative"
  data-gallery-id={galleryId}
  style={`aspect-ratio: ${containerAspectRatio};`}
>
  {
    processedImages.map((img, index) => (
      <div
        class="absolute"
        style={`left: ${boxes[index].left}%; top: ${(boxes[index].top / layout.containerHeight) * 100}%; width: ${boxes[index].width}%; height: ${(boxes[index].height / layout.containerHeight) * 100}%;`}
      >
        <ImageItem
          image={img.image}
          fullSrc={img.fullSrc}
          galleryId={galleryId}
          description={img.description}
          date={img.date}
          placeholderSrc={img.placeholderSrc}
          width={Math.round(boxes[index].width * 12)}
          widths={[200, 400, 600]}
          sizes={`${Math.round(boxes[index].width)}vw`}
          fill
        />
      </div>
    ))
  }
</div>
