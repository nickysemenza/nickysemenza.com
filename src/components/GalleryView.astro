---
import { getAlbumImages } from "../utils/albums";
import { Image, getImage } from "astro:assets";
import FormattedDate from "./FormattedDate.astro";
import justifiedLayout from "justified-layout";

interface Props {
  gallerySlug: string;
  targetRowHeight?: number;
  spacing?: number;
}

const { gallerySlug, targetRowHeight = 360, spacing = 8 } = Astro.props;
const images = await getAlbumImages(gallerySlug);

// Generate full-size images for lightbox and tiny placeholders for blur effect
const processedImages = await Promise.all(
  images.map(async (img) => {
    const [fullSize, placeholder] = await Promise.all([
      getImage({
        src: img.image,
        format: "webp",
        quality: 85,
        width: Math.min(img.image.width, 1600),
      }),
      getImage({
        src: img.image,
        format: "webp",
        quality: 10,
        width: 20,
      }),
    ]);
    return {
      fullSrc: fullSize.src,
      placeholderSrc: placeholder.src,
    };
  })
);

// Calculate aspect ratios for justified layout
const aspectRatios = images.map(
  (img) => img.image.width / img.image.height
);

// Compute layout at a base width - we'll convert to percentages for responsiveness
// Use a width closer to typical content area for better row height scaling
const BASE_WIDTH = 800;
const layout = justifiedLayout(aspectRatios, {
  containerWidth: BASE_WIDTH,
  targetRowHeight,
  boxSpacing: spacing,
});

// Convert to percentage-based positions for responsive scaling
const boxes = layout.boxes.map((box: { left: number; top: number; width: number; height: number }) => ({
  left: (box.left / BASE_WIDTH) * 100,
  top: box.top,
  width: (box.width / BASE_WIDTH) * 100,
  height: box.height,
}));

// Calculate aspect ratio of the entire container for responsive height
const containerAspectRatio = BASE_WIDTH / layout.containerHeight;

const galleryId = gallerySlug.replace(/[^a-zA-Z0-9]/g, "_");
---

<div
  class="gallery-justified w-full relative"
  data-gallery-id={galleryId}
  style={`aspect-ratio: ${containerAspectRatio};`}
>
  {
    images.map((image, index) => (
      <div
        class="absolute"
        style={`left: ${boxes[index].left}%; top: ${(boxes[index].top / layout.containerHeight) * 100}%; width: ${boxes[index].width}%; height: ${(boxes[index].height / layout.containerHeight) * 100}%;`}
      >
        <button
          type="button"
          class="gallery-thumb cursor-zoom-in block w-full h-full border-0 bg-transparent p-0 relative overflow-hidden rounded"
          data-index={index}
          data-full-src={processedImages[index].fullSrc}
          data-description={image.description || ""}
          aria-label={`View ${image.description || "image"} full size`}
        >
          <div
            class="gallery-placeholder absolute inset-0 bg-cover bg-center blur-lg scale-110 transition-opacity duration-300"
            style={`background-image: url('${processedImages[index].placeholderSrc}')`}
          />
          <Image
            src={image.image}
            alt={image.description || "Gallery image"}
            width={Math.round(boxes[index].width * 12)}
            widths={[200, 400, 600]}
            sizes={`${Math.round(boxes[index].width)}vw`}
            class="gallery-image w-full h-full object-cover relative transition-all duration-300 ease-in-out opacity-0"
            loading="lazy"
            quality={75}
            onload="this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('opacity-0')"
          />
          {(image.description || image.date) && (
            <div class="gallery-caption absolute bottom-2 left-2 pointer-events-none">
              <span class="bg-black/70 backdrop-blur-sm rounded px-1 py-0.5 text-white text-xs leading-none inline-flex items-center gap-1.5">
                {image.description && <span class="font-medium">{image.description}</span>}
                {image.description && image.date && <span class="text-white/50">Â·</span>}
                {image.date && <span class="text-white/80"><FormattedDate date={image.date} /></span>}
              </span>
            </div>
          )}
        </button>
      </div>
    ))
  }
</div>

<script define:vars={{ galleryId, imageCount: images.length }}>
  // Initialize lightbox for this gallery
  document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.querySelector(
      `[data-gallery-id="${galleryId}"]`
    );
    if (!gallery) return;

    const thumbs = gallery.querySelectorAll(".gallery-thumb");

    thumbs.forEach((thumb) => {
      thumb.addEventListener("click", () => {
        const index = parseInt(thumb.dataset.index, 10);
        const fullSrc = thumb.dataset.fullSrc;
        const description = thumb.dataset.description;

        // Collect all images in this gallery for navigation
        const allImages = Array.from(thumbs).map((t) => ({
          src: t.dataset.fullSrc,
          description: t.dataset.description,
        }));

        // Dispatch custom event to open lightbox
        window.dispatchEvent(
          new CustomEvent("openLightbox", {
            detail: { images: allImages, startIndex: index },
          })
        );
      });
    });
  });
</script>
