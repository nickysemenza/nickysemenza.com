---
// Lightbox component - include once in your layout
// Listens for openLightbox events from gallery components
---

<div
  id="lightbox"
  class="fixed inset-0 z-50 hidden bg-black/95 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-label="Image lightbox"
>
  <!-- Close button -->
  <button
    id="lightbox-close"
    type="button"
    class="absolute top-4 right-4 z-10 p-2 text-white/80 hover:text-white transition-colors rounded-full hover:bg-white/10"
    aria-label="Close lightbox"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-8 w-8"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"
      ></path>
    </svg>
  </button>

  <!-- Navigation buttons -->
  <button
    id="lightbox-prev"
    type="button"
    class="absolute left-4 top-1/2 -translate-y-1/2 z-10 p-3 text-white/80 hover:text-white transition-colors rounded-full hover:bg-white/10"
    aria-label="Previous image"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-10 w-10"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"
      ></path>
    </svg>
  </button>

  <button
    id="lightbox-next"
    type="button"
    class="absolute right-4 top-1/2 -translate-y-1/2 z-10 p-3 text-white/80 hover:text-white transition-colors rounded-full hover:bg-white/10"
    aria-label="Next image"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-10 w-10"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"
      ></path>
    </svg>
  </button>

  <!-- Image container -->
  <div class="flex items-center justify-center w-full h-full p-16">
    <div class="relative max-w-full max-h-full">
      <!-- Loading spinner -->
      <div
        id="lightbox-loader"
        class="absolute inset-0 flex items-center justify-center"
      >
        <div
          class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"
        >
        </div>
      </div>
      <img
        id="lightbox-image"
        src=""
        alt=""
        class="max-w-full max-h-[calc(100vh-8rem)] object-contain opacity-0 transition-opacity duration-300"
      />
    </div>
  </div>

  <!-- Caption -->
  <div
    id="lightbox-caption"
    class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/90 text-center max-w-xl px-4"
  >
    <p id="lightbox-description" class="text-lg"></p>
    <p id="lightbox-counter" class="text-sm text-white/60 mt-1"></p>
  </div>
</div>

<script>
  interface LightboxImage {
    src: string;
    description: string;
  }

  let images: LightboxImage[] = [];
  let currentIndex = 0;

  const lightbox = document.getElementById("lightbox");
  const lightboxImage = document.getElementById(
    "lightbox-image"
  ) as HTMLImageElement;
  const lightboxLoader = document.getElementById("lightbox-loader");
  const lightboxDescription = document.getElementById("lightbox-description");
  const lightboxCounter = document.getElementById("lightbox-counter");
  const closeBtn = document.getElementById("lightbox-close");
  const prevBtn = document.getElementById("lightbox-prev");
  const nextBtn = document.getElementById("lightbox-next");

  function showImage(index: number) {
    if (!lightbox || !lightboxImage || !lightboxLoader) return;

    currentIndex = index;
    const img = images[index];

    // Show loader, hide image
    lightboxLoader.classList.remove("hidden");
    lightboxImage.classList.add("opacity-0");

    // Preload image
    const preload = new Image();
    preload.onload = () => {
      lightboxImage.src = img.src;
      lightboxImage.alt = img.description || "Gallery image";
      lightboxLoader?.classList.add("hidden");
      lightboxImage.classList.remove("opacity-0");
    };
    preload.src = img.src;

    // Update caption
    if (lightboxDescription) {
      lightboxDescription.textContent = img.description || "";
    }
    if (lightboxCounter) {
      lightboxCounter.textContent = `${index + 1} / ${images.length}`;
    }

    // Update navigation visibility
    if (prevBtn) {
      prevBtn.style.visibility = index > 0 ? "visible" : "hidden";
    }
    if (nextBtn) {
      nextBtn.style.visibility =
        index < images.length - 1 ? "visible" : "hidden";
    }
  }

  function openLightbox(imgs: LightboxImage[], startIndex: number) {
    images = imgs;
    currentIndex = startIndex;

    if (lightbox) {
      lightbox.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      showImage(startIndex);

      // Preload adjacent images
      if (startIndex > 0) {
        new Image().src = imgs[startIndex - 1].src;
      }
      if (startIndex < imgs.length - 1) {
        new Image().src = imgs[startIndex + 1].src;
      }
    }
  }

  function closeLightbox() {
    if (lightbox) {
      lightbox.classList.add("hidden");
      document.body.style.overflow = "";
    }
  }

  function showPrev() {
    if (currentIndex > 0) {
      showImage(currentIndex - 1);
      // Preload next prev
      if (currentIndex > 1) {
        new Image().src = images[currentIndex - 2].src;
      }
    }
  }

  function showNext() {
    if (currentIndex < images.length - 1) {
      showImage(currentIndex + 1);
      // Preload next next
      if (currentIndex < images.length - 2) {
        new Image().src = images[currentIndex + 2].src;
      }
    }
  }

  // Event listeners
  window.addEventListener("openLightbox", ((event: CustomEvent) => {
    const { images: imgs, startIndex } = event.detail;
    openLightbox(imgs, startIndex);
  }) as EventListener);

  closeBtn?.addEventListener("click", closeLightbox);
  prevBtn?.addEventListener("click", showPrev);
  nextBtn?.addEventListener("click", showNext);

  // Click outside to close
  lightbox?.addEventListener("click", (e) => {
    if (e.target === lightbox) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (lightbox?.classList.contains("hidden")) return;

    switch (e.key) {
      case "Escape":
        closeLightbox();
        break;
      case "ArrowLeft":
        showPrev();
        break;
      case "ArrowRight":
        showNext();
        break;
    }
  });

  // Touch swipe support
  let touchStartX = 0;
  let touchEndX = 0;

  lightbox?.addEventListener(
    "touchstart",
    (e) => {
      touchStartX = e.changedTouches[0].screenX;
    },
    { passive: true }
  );

  lightbox?.addEventListener(
    "touchend",
    (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          showNext();
        } else {
          showPrev();
        }
      }
    },
    { passive: true }
  );
</script>
