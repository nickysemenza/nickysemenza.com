---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '@/components/FormattedDate.astro';
import { Picture } from 'astro:assets';
import Container from '@/components/Container.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import type { MarkdownHeading } from 'astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { formatDateRange } from '@/lib/projects';

interface Props {
  post: CollectionEntry<'blog'>;
  headings: MarkdownHeading[];
  readingTime: string;
}

const { post, headings, readingTime } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  startDate,
  endDate,
} = post.data;
const hasProjectDates = startDate !== undefined;
---

<BaseLayout
  title={title}
  description={description || title}
  image={heroImage?.src}
>
  <!-- BlogPosting Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: title,
      description: description || title,
      datePublished: pubDate.toISOString(),
      dateModified: updatedDate
        ? updatedDate.toISOString()
        : pubDate.toISOString(),
      author: {
        '@type': 'Person',
        name: 'Nicky Semenza',
        url: 'https://nickysemenza.com/about',
      },
      ...(heroImage && {
        image: {
          '@type': 'ImageObject',
          url: heroImage.src,
        },
      }),
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': Astro.url.href,
      },
    })}
  />
  <!-- Post Header -->
  <section
    class="bg-gradient-to-b from-stone-100/80 to-stone-50 border-b border-stone-200/50 py-6 md:py-10 construction-grid"
  >
    <Container>
      <div class="max-w-screen-md mx-auto text-center">
        <h1
          class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight text-stone-800"
        >
          {title}
        </h1>

        <div
          class="flex flex-wrap justify-center items-center gap-x-3 gap-y-1 mt-3 md:mt-4 text-stone-500 text-sm"
        >
          <span>Published <FormattedDate date={pubDate} pill={false} /></span>
          <span class="text-stone-300">Â·</span>
          <span>{readingTime}</span>
        </div>
        {
          hasProjectDates && (
            <div class="mt-2 text-sm">
              <span class="text-stone-400">Project:</span>{' '}
              <span class="text-[var(--color-copper)] font-medium">
                {formatDateRange(startDate!, endDate)}
              </span>
            </div>
          )
        }
      </div>
    </Container>
  </section>

  {
    heroImage && (
      <div class="relative z-0 max-w-screen-lg mx-auto overflow-hidden sm:px-4 lg:px-0">
        <Picture
          src={heroImage}
          widths={[400, 800, 1600]}
          alt="Thumbnail"
          loading="eager"
          class="w-full sm:rounded-lg"
          layout="full-width"
        />
      </div>
    )
  }
  <Container>
    <div class="flex gap-8 py-6 md:py-10">
      <article
        class="min-w-0 flex-1 prose prose-base prose-stone max-w-none prose-code:before:hidden prose-code:after:hidden dark:prose-invert prose-a:text-[var(--color-copper)] hover:prose-a:text-[var(--color-copper-dark)] prose-headings:text-stone-800 prose-img:rounded-lg prose-link-animated"
      >
        <!-- actual content in the slot -->
        <slot />
      </article>
      <aside class="hidden lg:block w-56 flex-shrink-0">
        <div class="sticky top-20">
          <TableOfContents headings={headings} levels={3} />
        </div>
      </aside>
    </div>
  </Container>
</BaseLayout>
